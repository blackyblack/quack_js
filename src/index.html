<!DOCTYPE html>
<html dir="ltr" lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <link rel="shortcut icon" href="img/favicon.png">

  <title>Quack</title>

  <!-- Bootstrap core CSS -->
  <link href="css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="css/style.css" rel="stylesheet">
  <link href="css/style-responsive.css" rel="stylesheet" />

  <!-- HTML5 shim and Respond.js IE8 support of HTML5 tooltipss and media queries -->
  <!--[if lt IE 9]>
  <script src="js/html5shiv.js"></script>
  <script src="js/respond.min.js"></script>
  <![endif]-->

</head>

<body class="full-width">

  <section id="container" class="">
    <button type="button" id="quackCreateButton" class="btn btn-success" data-toggle="modal" data-target="#quackCreateModal">Create</button>
    <button type="button" id="quackTriggerButton" class="btn btn-success" onclick="quackTrigger();">Trigger</button>
    <button type="button" id="quackAcceptButton" class="btn btn-success" onclick="quackAccept();">Accept</button>
    <button type="button" id="quackScanButton" class="btn btn-success" onclick="quackScan();">Scan</button>
  </section>

  <!-- Modals -->
  <div id="quackCreateModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Create Quack</h4>
        </div>
        <div class="modal-body">
          <form role="form" id="quackCreateForm" autocomplete="off">
            <div class="callout callout-danger error_message" style="display:none"></div>
            <label for="quackCreateRecipient" data-i18n="recipient">RECIPIENT</label>
            <input type="text" class="form-control" name="recipient" id="quackCreateRecipient" placeholder="Recipient Account" data-i18n="[placeholder]recipient_account" autofocus tabindex="1" />
            <div class="form-group secret_phrase">
              <label for="quackCreatePassword" data-i18n="passphrase">PASSPHRASE</label>
              <input type="password" name="secretPhrase" id="quackCreatePassword" class="form-control" placeholder="" tabindex="111">
            </div>
          </form>
        </div>
        <div class="modal-footer" style="margin-top:0;">
          <button type="button" class="btn btn-primary" data-loading-text="Submitting..." onclick="submitQuackCreate();">OK</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- js placed at the end of the document so the pages load faster -->
  <script src="js/jquery-1.11.1.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/maskedinput.js"></script>

  <!--common script for all pages-->
  <script src="js/constants.js"></script>
  <script src="js/quack.js"></script>
  <script src="js/app.js"></script>

  <script>
    $("#quackCreateModal").on("show.bs.modal", function() {
      var $inputFields = $(this).find("input[name=recipient], input[name=account_id], input[name=phasingWhitelisted]").not("[type=hidden]");
      $.each($inputFields, function() {
        if ($(this).hasClass("noMask")) {
          $(this).mask("NXT-****-****-****-*****", {
            "noMask": true
          }).removeClass("noMask");
        } else {
          $(this).mask("NXT-****-****-****-*****");
        }
      });
    });

    function submitProgress(modal) {
      var btn = modal.find("button.btn-primary:not([data-dismiss=modal])");
      modal.modal("lock");
      modal.find("button").prop("disabled", true);
      btn.button("loading");
    }

    function submitOk(modal) {
      var btn = modal.find("button.btn-primary:not([data-dismiss=modal])");
      modal.find("button").prop("disabled", false);
      btn.button("reset");
      modal.modal("unlock");
      modal.modal("hide");
    }

    function submitFailed(modal, response) {
      var btn = modal.find("button.btn-primary:not([data-dismiss=modal])");
      modal.find(".error_message").html(response).show();
      modal.find("button").prop("disabled", false);
      btn.button("reset");
      modal.modal("unlock");
    }

    function submitQuackCreate() {
      var modal = $("#quackCreateModal");
      submitProgress(modal);

      ///TODO: take data from form
      var senderRS = "NXT-YTBB-LT9J-SRRR-7KLBQ";
      var recipientRS = modal.find("#quackCreateRecipient").val();
      var secret = modal.find("#quackCreatePassword").val();
      var assets = new Array();
      var expectedAssets = new Array();
      var privateMessage = "";

      Quack.account = senderRS;

      assets.push({
        "id":"17091401215301664836",
        "QNT":5,
        "type":"A"
      });
      
      expectedAssets.push({
        "id":"1",
        "QNT":5,
        "type":"NXT"
      });

      $.post(Constants.nxtApiUrl, {
        "requestType": "getBlockchainStatus"
        },

        function(status) {

          var currentBlock = status.numberOfBlocks;

          if(currentBlock) {
            var finishHeight = currentBlock + Constants.swapBlocks;

            Quack.currentBlock = currentBlock;
            Quack.init(secret, recipientRS, finishHeight, assets, expectedAssets, privateMessage, function(result) {

              if(result.ret == "ok") {

                console.log("Success response");
                var ids = result.queue;
                ///TODO: check ids for 0 return. At least one 0 in ids is error.
                console.log("queue: " + ids);
                submitOk(modal);
              }
              else {
                console.log("Error response");
                console.log("result = " + JSON.stringify(result.result));
                submitFailed(modal, "Quack Create failed");
              }
            });
          } else {
            submitFailed(modal, "NRS problem occured");
          }
        },
        "json"
      ).fail(function() {
        submitFailed(modal, "NRS problem occured");
      });
    }
  </script>

</body>
</html>