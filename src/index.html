<!DOCTYPE html>
<html dir="ltr" lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <link rel="shortcut icon" href="img/favicon.png">

  <title>Quack</title>

  <!-- Bootstrap core CSS -->
  <link href="css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="css/style.css" rel="stylesheet">
  <link href="css/style-responsive.css" rel="stylesheet" />

  <!-- HTML5 shim and Respond.js IE8 support of HTML5 tooltipss and media queries -->
  <!--[if lt IE 9]>
  <script src="js/html5shiv.js"></script>
  <script src="js/respond.min.js"></script>
  <![endif]-->

</head>

<body class="full-width">

  <section id="container" class="">
    <button type="button" id="quackCreateButton" class="btn btn-success" data-toggle="modal" data-target="#quackCreateModal">Create</button>
    <button type="button" id="quackTriggerButton" class="btn btn-success" onclick="quackTrigger();">Trigger</button>
    <button type="button" id="quackAcceptButton" class="btn btn-success" onclick="quackAccept();">Accept</button>
    <button type="button" id="quackScanButton" class="btn btn-success" onclick="quackScan();">Scan</button>
  </section>

  <!-- Modals -->
  <div id="quackCreateModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Create Quack</h4>
        </div>
        <div class="modal-body">
          <form role="form" id="quackCreateForm" autocomplete="off">
            <div class="callout callout-danger error_message" style="display:none"></div>

            <!-- recipient field -->
            <div class="form-group">
              <label for="quackCreateRecipient" data-i18n="recipient">RECIPIENT</label>
              <input type="text" class="form-control" name="recipient" id="quackCreateRecipient" placeholder="Recipient Account" data-i18n="[placeholder]recipient_account" autofocus tabindex="1" />
            </div>

            <!-- swap group -->
            <div class="row">
              <!-- Send Part -->
              <div class="col-xs-6 col-sm-6 col-md-6">
                <div class="box box-primary">
                  <div class="box-header"><h3 class="box-title" data-i18n="send">Send</h3></div>
                  <div class="box-body no-padding">
                    <!-- asset type dropdown -->
                    <div class="form-group">
                      <label for="quackCreateAssetType" data-i18n="asset_type">ASSET TYPE</label>
                      <select class="form-control" name="quackCreateAssetTypeName" id="quackCreateAssetType">
                        <option value="NXT" data-i18n="nxt">NXT</option>
                        <option value="A" data-i18n="asset">Asset</option>
                        <option value="M" data-i18n="currency">Currency</option>
                      </select>
                    </div>

                    <!-- asset field -->
                    <div class="form-group" id="quackCreateAssetGroup" style="display:none">
                      <label for="quackCreateAsset" data-i18n="assetid">ASSET ID</label>
                      <input type="text" class="form-control" name="asset" id="quackCreateAsset" placeholder="Asset ID" data-i18n="[placeholder]asset" tabindex="1" />
                    </div>

                    <!-- currency field -->
                    <div class="form-group" id="quackCreateCurrencyGroup" style="display:none">
                      <label for="quackCreateCurrency" id="currencyid" data-i18n="uri">CURRENCY ID</label>
                      <input type="text" class="form-control" name="currency" id="quackCreateCurrency" placeholder="Currency" data-i18n="[placeholder]currency" tabindex="2" />
                    </div>

                    <!-- quantity field -->
                    <div class="form-group">
                       <label for="quackCreateQuantity" data-i18n="quantity">QUANTITY</label>
                      <div class="input-group">
                        <input type="number" name="quantity" id="quackCreateQuantity" class="form-control" step="any" min="0" placeholder="Quantity" data-i18n="[placeholder]quantity" tabindex="3">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Receive Part -->
              <div class="col-xs-6 col-sm-6 col-md-6">
                <div class="box box-primary">
                  <div class="box-header"><h3 class="box-title" data-i18n="send">Receive</h3></div>
                  <div class="box-body no-padding">
                    <!-- asset type dropdown -->
                    <div class="form-group">
                      <label for="quackCreateAssetType" data-i18n="asset_type">ASSET TYPE</label>
                      <select class="form-control" name="quackCreateExpectAssetTypeName" id="quackCreateExpectAssetType">
                        <option value="NXT" data-i18n="nxt">NXT</option>
                        <option value="A" data-i18n="asset">Asset</option>
                        <option value="M" data-i18n="currency">Currency</option>
                      </select>
                    </div>

                    <!-- asset field -->
                    <div class="form-group" id="quackCreateExpectAssetGroup" style="display:none">
                      <label for="quackCreateExpectAsset" data-i18n="assetid">ASSET ID</label>
                      <input type="text" class="form-control" name="asset" id="quackCreateExpectAsset" placeholder="Asset ID" data-i18n="[placeholder]asset" tabindex="1" />
                    </div>

                    <!-- currency field -->
                    <div class="form-group" id="quackCreateExpectCurrencyGroup" style="display:none">
                      <label for="quackCreateExpectCurrency" id="currencyid" data-i18n="uri">CURRENCY ID</label>
                      <input type="text" class="form-control" name="currency" id="quackCreateExpectCurrency" placeholder="Currency" data-i18n="[placeholder]currency" tabindex="2" />
                    </div>

                    <!-- quantity field -->
                    <div class="form-group">
                      <label for="quackCreateExpectQuantity" data-i18n="quantity">QUANTITY</label>
                      <div class="input-group">
                        <input type="number" name="quantity" id="quackCreateExpectQuantity" class="form-control" step="any" min="0" placeholder="Quantity" data-i18n="[placeholder]quantity" tabindex="3">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- secret phrase field -->
            <div class="form-group secret_phrase">
              <label for="quackCreatePassword" data-i18n="passphrase">PASSPHRASE</label>
              <input type="password" name="secretPhrase" id="quackCreatePassword" class="form-control" placeholder="" tabindex="111">
            </div>
          </form>
        </div>
        <div class="modal-footer" style="margin-top:0;">
          <button type="button" class="btn btn-primary" data-loading-text="Submitting..." onclick="submitQuackCreate();">OK</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- js placed at the end of the document so the pages load faster -->
  <script src="js/jquery-1.11.1.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/maskedinput.js"></script>
  <script src="js/jsbn.js"></script>
  <script src="js/jsbn2.js"></script>

  <!--common script for all pages-->
  <script src="js/constants.js"></script>
  <script src="js/quack.js"></script>
  <script src="js/quacksn.js"></script>
  <script src="js/app.js"></script>

  <script>
    $("#quackCreateModal").on("show.bs.modal", function () {
      var type = $("#quackCreateAssetType").val();
      if(type == "NXT") {
        $("#quackCreateAssetGroup").hide();
        $("#quackCreateCurrencyGroup").hide();
      } else if (type == "A") {
        $("#quackCreateAssetGroup").show();
        $("#quackCreateCurrencyGroup").hide();
      } else if (type == "M") {
        $("#quackCreateAssetGroup").hide();
        $("#quackCreateCurrencyGroup").show();
      }

      type = $("#quackCreateExpectAssetType").val();
      if(type == "NXT") {
        $("#quackCreateExpectAssetGroup").hide();
        $("#quackCreateExpectCurrencyGroup").hide();
      } else if (type == "A") {
        $("#quackCreateExpectAssetGroup").show();
        $("#quackCreateExpectCurrencyGroup").hide();
      } else if (type == "M") {
        $("#quackCreateExpectAssetGroup").hide();
        $("#quackCreateExpectCurrencyGroup").show();
      }
    });

    $("#quackCreateAssetType").on("change", function () {
        var type = $(this).val();
        if(type == "NXT") {
          $("#quackCreateAssetGroup").hide();
          $("#quackCreateCurrencyGroup").hide();
        } else if (type == "A") {
          $("#quackCreateAssetGroup").show();
          $("#quackCreateCurrencyGroup").hide();
        } else if (type == "M") {
          $("#quackCreateAssetGroup").hide();
          $("#quackCreateCurrencyGroup").show();
        }
    });

    $("#quackCreateExpectAssetType").on("change", function () {
        var type = $(this).val();
        if(type == "NXT") {
          $("#quackCreateExpectAssetGroup").hide();
          $("#quackCreateExpectCurrencyGroup").hide();
        } else if (type == "A") {
          $("#quackCreateExpectAssetGroup").show();
          $("#quackCreateExpectCurrencyGroup").hide();
        } else if (type == "M") {
          $("#quackCreateExpectAssetGroup").hide();
          $("#quackCreateExpectCurrencyGroup").show();
        }
    });

    function submitQuackCreate() {
      var modal = $("#quackCreateModal");
      submitProgress(modal);

      var recipientRS = modal.find("#quackCreateRecipient").val();
      var secret = modal.find("#quackCreatePassword").val();
      var assets = new Array();
      var expectedAssets = new Array();
      var privateMessage = "";
      var assetType = modal.find("#quackCreateAssetType").val();
      var assetId = modal.find("#quackCreateAsset").val();
      var assetQNT = modal.find("#quackCreateQuantity").val();

      var assetExpectType = modal.find("#quackCreateExpectAssetType").val();
      var assetExpectId = modal.find("#quackCreateExpectAsset").val();
      var assetExpectQNT = modal.find("#quackCreateExpectQuantity").val();

      if(!recipientRS) {
        submitFailed(modal, "Recipient not set");
        return;
      }

      if(!secret) {
        submitFailed(modal, "Secret phrase not set");
        return;
      }

      if(assetType == "NXT") assetId = "1";
      else {
        if(!assetId) {
          submitFailed(modal, "Asset ID not set");
          return;
        }
      }

      if(!assetQNT || assetQNT <= 0) {
        submitFailed(modal, "Quantity not set");
        return;
      }

      if(assetExpectType == "NXT") assetExpectId = "1";

      if(assetExpectQNT && assetExpectQNT > 0) {
        if(assetExpectType != "NXT" && !assetExpectId) {
          submitFailed(modal, "Receive Asset ID not set");
          return;
        }
      }

      assets.push({
        "id":assetId,
        "QNT":assetQNT,
        "type":assetType
      });
      
      if(assetExpectQNT) {
        expectedAssets.push({
          "id":assetExpectId,
          "QNT":assetExpectQNT,
          "type":assetExpectType
        });
      }

      var allAssets = new Array();
      for(i = 0; i < assets.length; i++) {
        var asset = assets[i];
        asset.reftype = "assets";
        allAssets.push(asset);
      }
      for(i = 0; i < expectedAssets.length; i++) {
        var asset = expectedAssets[i];
        asset.reftype = "expectedAssets";
        allAssets.push(asset);
      }

      $.post(Constants.nxtApiUrl, {
        "requestType": "getBlockchainStatus"
        },

        function(status) {

          var currentBlock = status.numberOfBlocks;

          if(currentBlock) {
            var finishHeight = currentBlock + Constants.swapBlocks;

            updateQuantity(allAssets, function(assetsState) {
              if(assetsState.ret == "ok") {

                var assetsWithQNT = new Array();
                var expectedAssetsWithQNT = new Array();
                for(i = 0; i < assetsState.state.length; i++) {
                  if(assetsState.state[i].decimals < 0) {
                    submitFailed(modal, "Incorrect Asset Id: " + assetsState.state[i].id);
                    return;
                  }
                  var asset = assetsState.state[i];
                  if(asset.reftype == "assets") {
                    delete asset.reftype;
                    delete asset.decimals;
                    assetsWithQNT.push(asset);
                  } else if (asset.reftype == "expectedAssets") {
                    delete asset.reftype;
                    delete asset.decimals;
                    expectedAssetsWithQNT.push(asset);
                  }
                }

                Quack.currentBlock = currentBlock;
                Quack.init(secret, recipientRS, finishHeight, assetsWithQNT, expectedAssetsWithQNT, privateMessage, function(result) {

                  if(result.ret == "ok") {

                    //console.log("Success response");
                    //var ids = result.queue;
                    ///TODO: check ids for 0 return. At least one 0 in ids is error.
                    //console.log("queue: " + ids);
                    submitOk(modal);
                  }
                  else {
                    //console.log("Error response");
                    console.log("result = " + JSON.stringify(result.result));
                    submitFailed(modal, "Quack Create failed");
                  }
                });
              } else {
                submitFailed(modal, "NRS problem occured");
              }
            });
          }
        },
        "json"
      ).fail(function() {
        submitFailed(modal, "NRS problem occured");
      });
    }
  </script>

</body>
</html>