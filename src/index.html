<!DOCTYPE html>
<html dir="ltr" lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <link rel="shortcut icon" href="img/favicon.png">

  <title>Quack</title>

  <!-- Bootstrap core CSS -->
  <link href="css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="css/style.css" rel="stylesheet">

  <!-- HTML5 shim and Respond.js IE8 support of HTML5 tooltipss and media queries -->
  <!--[if lt IE 9]>
  <script src="js/html5shiv.js"></script>
  <script src="js/respond.min.js"></script>
  <![endif]-->

</head>

<body class="full-width">

  <section id="container" class="">
    <!-- account field -->
    <div class="row" style="text-align:center;display:none" id="quackMainAccountGroup">
      <div style="width:300px;margin:0;margin:0 auto;padding:12px;">
        <form style="text-align:center" autocomplete="off">
          <label for="quackMainAccount" data-i18n="account">My Account</label>
          <input type="text" name="account" class="form-control" placeholder="My Account" data-i18n="[placeholder]my_account" id="quackMainAccount" />

          
        </form>
      </div>
    </div>

    <div class="row" style="text-align:center">
      <button type="button" id="quackCreateButton" class="btn btn-success" data-toggle="modal" data-target="#quackCreateModal">Create</button>
      <button type="button" id="quackScanButton" class="btn btn-success" onclick="quackScan();">Scan</button>
    </div>

    <div class="row" style="text-align:center">
      <h3>
        <span style="text-align:right" data-i18n="quack_height">Current height: </span>
        <span style="text-align:right" id="quackCurrentHeight">0</span>
      </h3>
    </div>
  </section>

  <div id="quackHistoryPage" class="page">
    <section class="content-header" style="text-align:center">
      <h2 data-i18n="quack_history">Quack History</h2>
    </section>
    <section class="content">
      <div class="data-container">
        <table class="table table-striped" id="quackHistoryTable">
          <thead>
            <tr>
              <th data-i18n="height">Finish Height</th>
              <th data-i18n="recipient">Recipient</th>
              <th data-i18n="sender">Sender</th>
              <th data-i18n="details">Details</th>
              <th data-i18n="status">Status</th>
            </tr>
          </thead>
          <tbody>
                    
          </tbody>
        </table>
        <div class="data-loading-container"><img src="img/loading_indicator.gif" alt="Loading..." width="32" height="32" /></div>
        <div class="data-container"><p data-i18n="no_quack_history" id="quackHistoryError">No Quack history available.</p></div>
      </div>
    </section>
  </div>

  <!-- Modals -->
  <div id="quackCreateModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Create Quack</h4>
        </div>
        <div class="modal-body">
          <form role="form" id="quackCreateForm" autocomplete="off">
            <div class="callout callout-danger error_message" style="display:none"></div>

            <!-- recipient field -->
            <div class="form-group">
              <label for="quackCreateRecipient" data-i18n="recipient">RECIPIENT</label>
              <input type="text" class="form-control" name="recipient" id="quackCreateRecipient" placeholder="Recipient Account" data-i18n="[placeholder]recipient_account" autofocus tabindex="1" />
            </div>

            <!-- swap group -->
            <div class="row">
              <!-- Send Part -->
              <div class="col-xs-6 col-sm-6 col-md-6">
                <div class="box box-primary">
                  <div class="box-header"><h3 class="box-title" data-i18n="send">Send</h3></div>
                  <div class="box-body no-padding">
                    <!-- asset type dropdown -->
                    <div class="form-group">
                      <label for="quackCreateAssetType" data-i18n="asset_type">ASSET TYPE</label>
                      <select class="form-control" name="quackCreateAssetTypeName" id="quackCreateAssetType">
                        <option value="NXT" data-i18n="nxt">NXT</option>
                        <option value="A" data-i18n="asset">Asset</option>
                        <option value="M" data-i18n="currency">Currency</option>
                      </select>
                    </div>

                    <!-- asset field -->
                    <div class="form-group" id="quackCreateAssetGroup" style="display:none">
                      <label for="quackCreateAsset" data-i18n="assetid">ASSET ID</label>
                      <input type="text" class="form-control" name="asset" id="quackCreateAsset" placeholder="Asset ID" data-i18n="[placeholder]asset" tabindex="1" />
                    </div>

                    <!-- currency field -->
                    <div class="form-group" id="quackCreateCurrencyGroup" style="display:none">
                      <label for="quackCreateCurrency" id="currencyid" data-i18n="uri">CURRENCY ID</label>
                      <input type="text" class="form-control" name="currency" id="quackCreateCurrency" placeholder="Currency" data-i18n="[placeholder]currency" tabindex="2" />
                    </div>

                    <!-- quantity field -->
                    <div class="form-group">
                       <label for="quackCreateQuantity" data-i18n="quantity">QUANTITY</label>
                      <div class="input-group">
                        <input type="number" name="quantity" id="quackCreateQuantity" class="form-control" step="any" min="0" placeholder="Quantity" data-i18n="[placeholder]quantity" tabindex="3">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Receive Part -->
              <div class="col-xs-6 col-sm-6 col-md-6">
                <div class="box box-primary">
                  <div class="box-header"><h3 class="box-title" data-i18n="send">Receive</h3></div>
                  <div class="box-body no-padding">
                    <!-- asset type dropdown -->
                    <div class="form-group">
                      <label for="quackCreateAssetType" data-i18n="asset_type">ASSET TYPE</label>
                      <select class="form-control" name="quackCreateExpectAssetTypeName" id="quackCreateExpectAssetType">
                        <option value="NXT" data-i18n="nxt">NXT</option>
                        <option value="A" data-i18n="asset">Asset</option>
                        <option value="M" data-i18n="currency">Currency</option>
                      </select>
                    </div>

                    <!-- asset field -->
                    <div class="form-group" id="quackCreateExpectAssetGroup" style="display:none">
                      <label for="quackCreateExpectAsset" data-i18n="assetid">ASSET ID</label>
                      <input type="text" class="form-control" name="asset" id="quackCreateExpectAsset" placeholder="Asset ID" data-i18n="[placeholder]asset" tabindex="1" />
                    </div>

                    <!-- currency field -->
                    <div class="form-group" id="quackCreateExpectCurrencyGroup" style="display:none">
                      <label for="quackCreateExpectCurrency" id="currencyid" data-i18n="uri">CURRENCY ID</label>
                      <input type="text" class="form-control" name="currency" id="quackCreateExpectCurrency" placeholder="Currency" data-i18n="[placeholder]currency" tabindex="2" />
                    </div>

                    <!-- quantity field -->
                    <div class="form-group">
                      <label for="quackCreateExpectQuantity" data-i18n="quantity">QUANTITY</label>
                      <div class="input-group">
                        <input type="number" name="quantity" id="quackCreateExpectQuantity" class="form-control" step="any" min="0" placeholder="Quantity" data-i18n="[placeholder]quantity" tabindex="3">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- secret phrase field -->
            <div class="form-group secret_phrase">
              <label for="quackCreatePassword" data-i18n="passphrase">PASSPHRASE</label>
              <input type="password" name="secretPhrase" id="quackCreatePassword" class="form-control" placeholder="" tabindex="111">
            </div>
          </form>
        </div>
        <div class="modal-footer" style="margin-top:0;">
          <button type="button" class="btn btn-primary" data-loading-text="Submitting..." onclick="submitQuackCreate();">Create</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quack Accept modal -->
  <div id="quackAcceptModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Accept Quack</h4>
        </div>
        <div class="modal-body">
          <form role="form" id="quackAcceptForm" autocomplete="off">
            <div class="callout callout-danger error_message" style="display:none"></div>

            <!-- secret phrase field -->
            <div class="form-group secret_phrase">
              <label for="quackAcceptPassword" data-i18n="passphrase">PASSPHRASE</label>
              <input type="password" name="secretPhrase" id="quackAcceptPassword" class="form-control" placeholder="" tabindex="111">
            </div>
          </form>
        </div>
        <div class="modal-footer" style="margin-top:0;">
          <button type="button" class="btn btn-primary" data-loading-text="Submitting..." onclick="submitQuackAccept();">Accept</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quack Finalize modal -->
  <div id="quackFinalizeModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Finalize Quack</h4>
        </div>
        <div class="modal-body">
          <form role="form" id="quackFinalizeForm" autocomplete="off">
            <div class="callout callout-danger error_message" style="display:none"></div>

            <!-- secret phrase field -->
            <div class="form-group secret_phrase">
              <label for="quackFinalizePassword" data-i18n="passphrase">PASSPHRASE</label>
              <input type="password" name="secretPhrase" id="quackFinalizePassword" class="form-control" placeholder="" tabindex="111">
            </div>
          </form>
        </div>
        <div class="modal-footer" style="margin-top:0;">
          <button type="button" class="btn btn-primary" data-loading-text="Submitting..." onclick="submitQuackTrigger();">Finalize</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quack Details modal -->
  <div id="quackDetailsModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Quack Details</h4>
        </div>
        <div class="modal-body">
          <form role="form" id="quackDetailsForm" autocomplete="off">
            <div class="callout callout-danger error_message" style="display:none"></div>
            <section class="content-header" style="text-align:center"><h3 data-i18n="send_side">Send</h3></section>
            <section class="content">
              <div class="data-container">
                <table class="table table-striped" id="quackSendAssetsTable">
                  <thead>
                    <tr>
                      <th data-i18n="height">Finish Height</th>
                      <th data-i18n="asset">Asset</th>
                      <th data-i18n="type">Type</th>
                      <th data-i18n="asset">Quantity</th>
                      <th data-i18n="confirmations">Confirmations</th>
                      <th data-i18n="status">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    
                  </tbody>
                </table>
              </div>
            </section>

            <section class="content-header" style="text-align:center"><h3 data-i18n="receive_side">Receive</h3></section>
            <section class="content">
              <div class="data-container">
                <table class="table table-striped" id="quackReceiveAssetsTable">
                  <thead>
                    <tr>
                      <th data-i18n="height">Finish Height</th>
                      <th data-i18n="asset">Asset</th>
                      <th data-i18n="type">Type</th>
                      <th data-i18n="asset">Quantity</th>
                      <th data-i18n="confirmations">Confirmations</th>
                      <th data-i18n="status">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    
                  </tbody>
                </table>
              </div>
            </section>
          </form>
        </div>
        <div class="modal-footer" style="margin-top:0;">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- js placed at the end of the document so the pages load faster -->
  <script src="js/jquery-1.11.1.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/maskedinput.js"></script>
  <script src="js/jsbn.js"></script>
  <script src="js/jsbn2.js"></script>

  <!--common script for all pages-->
  <script src="js/quack.constants.js"></script>
  <script src="js/quack.utils.js"></script>
  <script src="js/quack.api.js"></script>
  <script src="js/quack.sn.js"></script>

  <script>
    $(document).ready(function() {
      if(Quack.constants.isPlugin) {
        $("#quackMainAccountGroup").hide();
      } else {
        $("#quackMainAccount").mask("NXT-****-****-****-*****");
        $("#quackMainAccountGroup").show();
      }
    });

    var submitProgress = function(modal) {
    }

    var submitOk = function(modal) {
      modal.modal("hide");
    }

    var submitFailed = function(modal, response) {
      modal.find(".error_message").html(response).show();
    }

    if(!Quack.constants.isPlugin) {
      submitProgress = Quack.sn.submitProgress;
      submitOk = Quack.sn.submitOk;
      submitFailed = Quack.sn.submitFailed;
    }

    $("#quackCreateModal").on("show.bs.modal", function () {
      var type = $("#quackCreateAssetType").val();
      if(type == "NXT") {
        $("#quackCreateAssetGroup").hide();
        $("#quackCreateCurrencyGroup").hide();
      } else if (type == "A") {
        $("#quackCreateAssetGroup").show();
        $("#quackCreateCurrencyGroup").hide();
      } else if (type == "M") {
        $("#quackCreateAssetGroup").hide();
        $("#quackCreateCurrencyGroup").show();
      }

      type = $("#quackCreateExpectAssetType").val();
      if(type == "NXT") {
        $("#quackCreateExpectAssetGroup").hide();
        $("#quackCreateExpectCurrencyGroup").hide();
      } else if (type == "A") {
        $("#quackCreateExpectAssetGroup").show();
        $("#quackCreateExpectCurrencyGroup").hide();
      } else if (type == "M") {
        $("#quackCreateExpectAssetGroup").hide();
        $("#quackCreateExpectCurrencyGroup").show();
      }
    });

    $("#quackCreateAssetType").on("change", function () {
      var type = $(this).val();
      if(type == "NXT") {
        $("#quackCreateAssetGroup").hide();
        $("#quackCreateCurrencyGroup").hide();
      } else if (type == "A") {
        $("#quackCreateAssetGroup").show();
        $("#quackCreateCurrencyGroup").hide();
      } else if (type == "M") {
        $("#quackCreateAssetGroup").hide();
        $("#quackCreateCurrencyGroup").show();
      }
    });

    $("#quackCreateExpectAssetType").on("change", function () {
      var type = $(this).val();
      if(type == "NXT") {
        $("#quackCreateExpectAssetGroup").hide();
        $("#quackCreateExpectCurrencyGroup").hide();
      } else if (type == "A") {
        $("#quackCreateExpectAssetGroup").show();
        $("#quackCreateExpectCurrencyGroup").hide();
      } else if (type == "M") {
        $("#quackCreateExpectAssetGroup").hide();
        $("#quackCreateExpectCurrencyGroup").show();
      }
    });

    $("#quackDetailsModal").on("show.bs.modal", function () {

      var modal = $("#quackDetailsModal");      
      var key = modal.attr("extra");
      var swap = Quack.api.swaps.get(key);
      var rows = "";

      var allAssets = new Array();
      for(i = 0; i < swap.assets.length; i++) {
        var asset = swap.assets[i];
        asset.reftype = "assets";
        asset.quantity = asset.QNT;
        allAssets.push(asset);
      }
      for(i = 0; i < swap.expectedAssets.length; i++) {
        var asset = swap.expectedAssets[i];
        asset.reftype = "expectedAssets";
        asset.quantity = asset.QNT;
        allAssets.push(asset);
      }

      Quack.utils.parseQuantity(allAssets, function(assetsState) {
        if(assetsState.ret == "ok") {
          var assetsWithQNT = new Array();
          var expectedAssetsWithQNT = new Array();
          for(i = 0; i < assetsState.state.length; i++) {
            if(assetsState.state[i].decimals < 0) {
              continue;
            }
            var asset = assetsState.state[i];
            if(asset.reftype == "assets") {
              assetsWithQNT.push(asset);
            } else if (asset.reftype == "expectedAssets") {
              expectedAssetsWithQNT.push(asset);
            }
          }
          var status = "Unknown";
          var confirmations = 0;

          ///TODO: get status and confirmations from assetsA/assetsB

          for(i = 0; i < assetsWithQNT.length; i++) {
            var asset = assetsWithQNT[i];

            var assetType = asset.type;
            if (assetType == "A") assetType = "Asset";
            else if (assetType == "M") assetType = "Currency";

            var assetId = asset.id;
            if (asset.type == "NXT") assetId = "undefined";

            rows +=
              "<tr><td>" + /*asset.tx.finishHeight*/0 + "</td>" +
              "<td>" + assetId + "</td>" +
              "<td>" + assetType + "</td>" +
              "<td>" + asset.QNT + "</td>" +
              "<td>" + /*asset.tx.confirmations*/0 + "</td>" +
              "<td>" + status + "</td>" +
              "</tr>";
          }
          var el = $("#quackSendAssetsTable");
          el.find("tbody").empty().append(rows);
          rows = "";
          for(i = 0; i < expectedAssetsWithQNT.length; i++) {
            var asset = expectedAssetsWithQNT[i];

            var assetType = asset.type;
            if (assetType == "A") assetType = "Asset";
            else if (assetType == "M") assetType = "Currency";

            var assetId = asset.id;
            if (asset.type == "NXT") assetId = "undefined";

            rows +=
              "<tr><td>" + /*asset.tx.finishHeight*/0 + "</td>" +
              "<td>" + assetId + "</td>" +
              "<td>" + assetType + "</td>" +
              "<td>" + asset.QNT + "</td>" +
              "<td>" + /*asset.tx.confirmations*/0 + "</td>" +
              "<td>" + status + "</td>" +
              "</tr>";
          }
          var el = $("#quackReceiveAssetsTable");
          el.find("tbody").empty().append(rows);
        }
      });
    });

    function pageLoading() {
      var $el = $("#quackHistoryTable");
      var $parent = $el.parent();
      $parent.addClass("data-loading");
      $("#quackHistoryError").hide();
    }

    function dataLoaded(data) {
      var $el = $("#quackHistoryTable");
      $el.find("tbody").empty().append(data);

      dataLoadFinished($el);
    }

    function dataLoadFinished($el, fadeIn) {
      var $parent = $el.parent();

      if (fadeIn) {
        $parent.hide();
      }

      $parent.removeClass("data-loading");
    }

    function submitQuackCreate() {
      var modal = $("#quackCreateModal");
      submitProgress(modal);

      var recipientRS = modal.find("#quackCreateRecipient").val();
      var secret = modal.find("#quackCreatePassword").val();
      var assets = new Array();
      var expectedAssets = new Array();
      var privateMessage = Quack.constants.defaultMessage;
      var assetType = modal.find("#quackCreateAssetType").val();
      var assetId = modal.find("#quackCreateAsset").val();
      var assetQNT = modal.find("#quackCreateQuantity").val();

      var assetExpectType = modal.find("#quackCreateExpectAssetType").val();
      var assetExpectId = modal.find("#quackCreateExpectAsset").val();
      var assetExpectQNT = modal.find("#quackCreateExpectQuantity").val();

      if(!recipientRS) {
        submitFailed(modal, "Recipient not set");
        return;
      }

      if(!secret) {
        submitFailed(modal, "Secret phrase not set");
        return;
      }

      if(assetType == "NXT") assetId = "1";
      else {
        if(!assetId) {
          submitFailed(modal, "Asset ID not set");
          return;
        }
      }

      if(!assetQNT || assetQNT <= 0) {
        submitFailed(modal, "Quantity not set");
        return;
      }

      if(assetExpectType == "NXT") assetExpectId = "1";

      if(assetExpectQNT && assetExpectQNT > 0) {
        if(assetExpectType != "NXT" && !assetExpectId) {
          submitFailed(modal, "Receive Asset ID not set");
          return;
        }
      }

      assets.push({
        "id":assetId,
        "QNT":assetQNT,
        "type":assetType
      });
      
      if(assetExpectQNT) {
        expectedAssets.push({
          "id":assetExpectId,
          "QNT":assetExpectQNT,
          "type":assetExpectType
        });
      }

      var allAssets = new Array();
      for(i = 0; i < assets.length; i++) {
        var asset = assets[i];
        asset.reftype = "assets";
        allAssets.push(asset);
      }
      for(i = 0; i < expectedAssets.length; i++) {
        var asset = expectedAssets[i];
        asset.reftype = "expectedAssets";
        allAssets.push(asset);
      }

      $.post(Quack.constants.nxtApiUrl, {
        "requestType": "getBlockchainStatus"
        },

        function(status) {

          var currentBlock = status.numberOfBlocks;

          if(currentBlock) {
            var finishHeight = currentBlock + Quack.constants.swapBlocks;

            Quack.utils.updateQuantity(allAssets, function(assetsState) {
              if(assetsState.ret == "ok") {

                var assetsWithQNT = new Array();
                var expectedAssetsWithQNT = new Array();
                for(i = 0; i < assetsState.state.length; i++) {
                  if(assetsState.state[i].decimals < 0) {
                    submitFailed(modal, "Incorrect Asset Id: " + assetsState.state[i].id);
                    return;
                  }
                  var asset = assetsState.state[i];
                  if(asset.reftype == "assets") {
                    delete asset.reftype;
                    delete asset.decimals;
                    assetsWithQNT.push(asset);
                  } else if (asset.reftype == "expectedAssets") {
                    delete asset.reftype;
                    delete asset.decimals;
                    expectedAssetsWithQNT.push(asset);
                  }
                }

                Quack.api.currentBlock = currentBlock;
                Quack.api.init(secret, recipientRS, finishHeight, assetsWithQNT, expectedAssetsWithQNT, privateMessage, function(result) {

                  if(result.ret == "ok") {

                    //console.log("Success response");
                    var ids = result.queue;
                    var queueOk = false;
                    for(k = 0; k < ids.length; k++) {
                      if (!ids[k]) continue;
                      if (ids[k] == "") continue;
                      if (ids[k] == "0") continue;
                      queueOk = true;
                    }

                    if (queueOk) {
                      submitOk(modal);
                    } else {
                      if(ids.length > 0) {
                        submitFailed(modal, "NRS partial response received. Check your Quacks status later.");
                      } else {
                        submitFailed(modal, "Quack Create failed");
                      }
                    }

                  }
                  else {
                    //console.log("Error response");
                    console.log("result = " + JSON.stringify(result.result));
                    submitFailed(modal, "Quack Create failed");
                  }
                });
              } else {
                submitFailed(modal, "NRS problem occured");
              }
            });
          }
        },
        "json"
      ).fail(function() {
        submitFailed(modal, "NRS problem occured");
      });
    }

    function submitQuackAccept() {
      var modal = $("#quackAcceptModal");
      submitProgress(modal);
      
      var key = modal.attr("extra");
      var swap = Quack.api.swaps.get(key);
      var assets = swap.expectedAssets;
      var secret = modal.find("#quackAcceptPassword").val();

      $.post(Quack.constants.nxtApiUrl, {
        "requestType": "getBlockchainStatus"
        },

        function(status) {

          var currentBlock = status.numberOfBlocks;
          var finishHeight = swap.minFinishHeight;
          var triggerHash = key;

          if(currentBlock) {

            Quack.api.currentBlock = currentBlock;
            Quack.api.accept(secret, swap.sender, finishHeight, assets, triggerHash, function(result) {

              ///TODO: make proper NRS error processing
              if(result.ret == "ok") {

                var ids = result.queue;
                var queueOk = false;
                for(k = 0; k < ids.length; k++) {
                  if (!ids[k]) continue;
                  if (ids[k] == "") continue;
                  if (ids[k] == "0") continue;
                  queueOk = true;
                }

                if (queueOk) {
                  submitOk(modal);
                } else {
                  if(ids.length > 0) {
                    submitFailed(modal, "NRS partial response received. Check your Quacks status later.");
                  } else {
                    submitFailed(modal, "Quack Accept failed");
                  }
                }

              }
              else {
                //console.log("Error response");
                console.log("result = " + JSON.stringify(result.result));
                submitFailed(modal, "Quack Accept failed");
              }
        
            });
          } else {
            submitFailed(modal, "NRS problem occured");
          }
        },
        "json"
      ).fail(function() {
        submitFailed(modal, "NRS problem occured");
      });
    }

    function submitQuackTrigger() {
      var modal = $("#quackFinalizeModal");
      submitProgress(modal);
      
      var key = modal.attr("extra");
      var swap = Quack.api.swaps.get(key);
      var assets = swap.expectedAssets;
      var secret = modal.find("#quackFinalizePassword").val();

      $.post(Quack.constants.nxtApiUrl, {
        "requestType": "getBlockchainStatus"
        },

        function(status) {

          var currentBlock = status.numberOfBlocks;
          var finishHeight = swap.minFinishHeight;
          var triggerBytes = swap.triggerBytes;

          ///TODO: check finish height one more time

          if(currentBlock) {

            Quack.api.currentBlock = currentBlock;
            Quack.api.trigger(secret, triggerBytes, function(result)  {

              ///TODO: make proper NRS error processing
              if(result.ret == "ok") {

                var id = result.txid;

                if (id && id != "" && id != "0") {
                  submitOk(modal);
                } else {
                  submitFailed(modal, "Quack Trigger failed");
                }

              }
              else {
                //console.log("Error response");
                console.log("result = " + JSON.stringify(result.result));
                submitFailed(modal, "Quack Trigger failed");
              }
        
            });
          } else {
            submitFailed(modal, "NRS problem occured");
          }
        },
        "json"
      ).fail(function() {
        submitFailed(modal, "NRS problem occured");
      });
    }

    function quackScan() {
      var rows = "";
      var account = $("#quackMainAccount").val();
      var timelimit = 60 * 60 * 24 * 100;

      pageLoading();

      $.post(Quack.constants.nxtApiUrl, {
        "requestType": "getBlockchainStatus"
        },

        function(status) {

          var currentBlock = status.numberOfBlocks;

          if(currentBlock) {
            $("#quackCurrentHeight").html(currentBlock);
            Quack.api.currentBlock = currentBlock;
            Quack.utils.scanHelper(account, timelimit, function(result) {

              if(result.ret == "ok") {

                var swaps = result.state.lookup;
                Quack.api.swaps = swaps;

                var status = "Unknown";
                for (var key of swaps.keys()) {
                  var swap = swaps.get(key);

                  if(swap.gotTrigger) {
                    status = "Finalized";
                  } else {
                    //show Expired status for B earlier since A should have time to finalize it
                    var limitBlocks = Quack.constants.defaultConfirmations;
                    if(account == swap.recipient) {
                      limitBlocks = Quack.constants.defaultConfirmations * 2;
                    }
                    if(swap.minFinishHeight < (currentBlock + limitBlocks)) status = "Expired";
                    else {
                      status = quackGetStatus(account, swap);
                    }
                  }
                  
                  if(status == "Valid") {
                    if (account == swap.sender) {
                      status = "<button type=\"button\" class=\"btn btn-success\" onclick=\"quackSwapTrigger(this);\" extra=\"" + key + "\">Finalize</button>";
                    }
                  } else if(status == "PendingB") {
                    if (account == swap.recipient) {
                      status = "<button type=\"button\" class=\"btn btn-success\" onclick=\"quackSwapAccept(this);\" extra=\"" + key + "\">Accept</button>";
                    }
                  }

                  rows += "<tr><td>" + swap.minFinishHeight + "</td>" +
                    "<td>" + swap.recipient + "</td>" +
                    "<td>" + swap.sender + "</td>" +
                    "<td><button type=\"button\" class=\"btn btn-success\" onclick=\"quackSwapDetails(this);\" extra=\"" + key + "\">Details</button></td>" +
                    "<td>" + status + "</td>" +
                    "</tr>";
                  
                }

                if (rows.length == 0) {
                  $("#quackHistoryError").html("No Quack history available.").show();
                }
                dataLoaded(rows);
              } else {
                $("#quackHistoryError").html("Error response.").show();
                dataLoaded(rows);
              }
            });
          } else {
            $("#quackHistoryError").html("NRS problem occured.").show();
            dataLoaded(rows);
          }
        },
        "json"
      ).fail(function() {
        $("#quackHistoryError").html("NRS problem occured.").show();
        dataLoaded(rows);
      });
    }

    function quackGetStatus(account, swap) {
      var status = "Pending";
      var isSender = false;

      var senderChecker = new Array();
      var recipientChecker = new Array();

      var assetsA = swap.assetsA;
      var assetsB = swap.assetsB;

      //check that assetsA is equal to announcedAssets (PendingA)
      if (swap.assets) {

        for(i = 0; i < swap.assets.length; i++) {
          var annAsset = swap.assets[i];
          if(!annAsset) continue;

          annAsset.validated = false;

          if (assetsA) {

            for(k = 0; k < assetsA.length; k++) {
              var gotAsset = assetsA[i];

              if(!gotAsset) continue;
              if(annAsset.id != gotAsset.id) continue;
              if(annAsset.QNT > gotAsset.QNT) continue;
              if(annAsset.type != gotAsset.type) continue;
              annAsset.validated = true;
            }
          }

          senderChecker.push(annAsset);
        }
      }

      //check that assetsB is equal to expectedAssets (PendingB)
      if (swap.expectedAssets) {

        for(i = 0; i < swap.expectedAssets.length; i++) {
          var annAsset = swap.expectedAssets[i];
          if(!annAsset) continue;

          annAsset.validated = false;

          if (assetsB) {

            for(k = 0; k < assetsB.length; k++) {
              var gotAsset = assetsB[i];

              if(!gotAsset) continue;
              if(annAsset.id != gotAsset.id) continue;
              if(annAsset.QNT > gotAsset.QNT) continue;
              if(annAsset.type != gotAsset.type) continue;
              annAsset.validated = true;
            }
          }

          recipientChecker.push(annAsset);
        }
      }

      for(i = 0; i < senderChecker.length; i++) {
        if (!senderChecker[i].validated) {
          status = "PendingA";
          return status;
        }
      }

      for(i = 0; i < recipientChecker.length; i++) {
        if (!recipientChecker[i].validated) {
          status = "PendingB";
          return status;
        }
      }

      if(swap.minConfirmationsA < Quack.constants.defaultConfirmations) {
        status = "UnconfirmedA";
        return status;
      }

      if(swap.minConfirmationsB < Quack.constants.defaultConfirmations) {
        status = "UnconfirmedB";
        return status;
      }

      if(swap.minFinishHeightB > swap.minFinishHeightA) {
        status = "Invalid";
        return status;
      }

      status = "Valid";
      return status;
    }

    function quackSwapDetails(btn) {
      var key = btn.getAttribute("extra");
      $("#quackDetailsModal").attr("extra", key);
      $("#quackDetailsModal").modal("show");
    }

    function quackSwapTrigger(btn) {
      //attach hash to modal and show it
      var key = btn.getAttribute("extra");
      $("#quackFinalizeModal").attr("extra", key);
      $("#quackFinalizeModal").modal("show");
    }

    function quackSwapAccept(btn) {
      //attach hash to modal and show it
      var key = btn.getAttribute("extra");
      $("#quackAcceptModal").attr("extra", key);
      $("#quackAcceptModal").modal("show");
    }

  </script>

</body>
</html>